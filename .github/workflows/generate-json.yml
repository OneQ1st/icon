name: Generate icon.json and Bitwarden API

on:
  push:
    paths:
      - '*'
      - '!.*'
      - '!.github/**'
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build icon.json and API folders
        run: |
          shopt -s nullglob
          REPO="${{ github.repository }}"
          
          # 1. 清理旧目录，确保数据纯净
          rm -rf api
          mkdir -p api
          
          # 2. 初始化 JSON
          echo "[]" > tmp.json
          
          # 3. 循环处理所有图片文件
          for f in *.{png,jpg,jpeg,svg,webp}; do
            # 跳过生成的系统文件
            if [[ "$f" == "icon.json" || "$f" == "index.html" || "$f" == "apple-touch-icon.png" ]]; then continue; fi
            
            NAME="${f%.*}"
            URL="https://raw.githubusercontent.com/$REPO/main/$f"
            
            # 写入 icon.json 数据
            jq --arg n "$NAME" --arg u "$URL" '. += [{"name": $n, "url": $u}]' tmp.json > t.json && mv t.json tmp.json
            
            # 创建 API 目录
            mkdir -p "api/$NAME"
            
            # 复制图标
            cp "$f" "api/$NAME/apple-touch-icon.png"
            cp "$f" "api/$NAME/favicon.ico"
            
            # 【核心】生成 index.html 供爬虫抓取
            cat <<EOF > "api/$NAME/index.html"
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="favicon.ico">
  <title>Icon API - $NAME</title>
</head>
<body>
  <img src="apple-touch-icon.png" alt="$NAME">
</body>
</html>
EOF
          done
          
          # 4. 封装成最终的 icon.json
          jq -n --slurpfile i tmp.json '{name: "solnce 图标库", description: "自动同步自 GitHub 仓库", icons: $i[0]}' > icon.json
          rm tmp.json

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update icons, index.html and api folders [skip ci]"
          # 关键：使用 api/ 确保提交该目录下所有子目录及文件
          file_pattern: "icon.json index.html api/"
