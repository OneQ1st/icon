name: Generate square.json and circle.json (only 128 in index)

on:
  push:
    paths:
      - '**.png'
      - '**.jpg'
      - '**.jpeg'
      - '**.svg'
      - '**.webp'
      - '**.gif'
    branches: [main]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Pillow
        run: pip install pillow

      - name: Generate multi-size icons but index only 128x128
        run: |
          python - <<'PY'
          import os
          import json
          from datetime import datetime
          from PIL import Image, ImageDraw

          REPO = os.getenv("GITHUB_REPOSITORY")
          ALL_SIZES = [16, 32, 64, 128, 256, 512]
          INDEX_SIZE = 128  # JSON 只索引这个尺寸

          square_icons = []  # square.json: 只包含 128-square.png
          circle_icons = []  # circle.json: 只包含 128-circle.png

          os.makedirs("resized", exist_ok=True)

          for file in os.listdir("."):
            lowercase = file.lower()
            if lowercase.endswith((".png", ".jpg", ".jpeg", ".webp", ".gif")) and os.path.isfile(file):
              name = os.path.splitext(file)[0]
              icon_dir = os.path.join("resized", name)
              os.makedirs(icon_dir, exist_ok=True)

              try:
                  with Image.open(file) as orig_img:
                    orig_img = orig_img.convert("RGBA")

                    # 生成所有尺寸（但只在 INDEX_SIZE 时记录到 JSON）
                    for size in ALL_SIZES:
                      # --- 方形 ---
                      img = orig_img.copy()
                      img.thumbnail((size, size), Image.LANCZOS)
                      if img.size != (size, size):
                          bg = Image.new("RGBA", (size, size), (0, 0, 0, 0))
                          offset = ((size - img.width) // 2, (size - img.height) // 2)
                          bg.paste(img, offset, img)
                          img = bg

                      square_path = os.path.join(icon_dir, f"{size}-square.png")
                      img.save(square_path, "PNG", optimize=True)

                      # 只在 128 时添加到索引
                      if size == INDEX_SIZE:
                          square_url = f"https://raw.githubusercontent.com/{REPO}/main/{square_path}"
                          square_icons.append({
                              "name": name,
                              "url": square_url,
                              "size": "128x128",
                              "type": "png",
                              "shape": "square"
                          })

                      # --- 圆形 ---
                      img = orig_img.copy()
                      img.thumbnail((size, size), Image.LANCZOS)
                      if img.size != (size, size):
                          bg = Image.new("RGBA", (size, size), (0, 0, 0, 0))
                          offset = ((size - img.width) // 2, (size - img.height) // 2)
                          bg.paste(img, offset, img)
                          img = bg

                      mask = Image.new("L", (size, size), 0)
                      draw = ImageDraw.Draw(mask)
                      draw.ellipse((0, 0, size, size), fill=255)
                      circle_output = Image.new("RGBA", (size, size), (0, 0, 0, 0))
                      circle_output.paste(img, (0, 0), mask)

                      circle_path = os.path.join(icon_dir, f"{size}-circle.png")
                      circle_output.save(circle_path, "PNG", optimize=True)

                      # 只在 128 时添加到索引
                      if size == INDEX_SIZE:
                          circle_url = f"https://raw.githubusercontent.com/{REPO}/main/{circle_path}"
                          circle_icons.append({
                              "name": name,
                              "url": circle_url,
                              "size": "128x128",
                              "type": "png",
                              "shape": "circle"
                          })

              except Exception as e:
                  print(f"Failed to process {file}: {e}")

            # SVG：只索引原始文件（标为 128x128）
            elif lowercase.endswith(".svg") and os.path.isfile(file):
              name = os.path.splitext(file)[0]
              url = f"https://raw.githubusercontent.com/{REPO}/main/{file}"
              entry = {
                  "name": name,
                  "url": url,
                  "size": "128x128",
                  "type": "svg"
              }
              square_icons.append({**entry, "shape": "square"})
              circle_icons.append({**entry, "shape": "circle"})

          # 生成 square.json（仅 128x128 方形）
          square_data = {
              "name": "solnce 128x128 方形图标库",
              "description": "仓库内所有图标的 128x128 方形版本索引（位于 resized/<name>/128-square.png，其他尺寸文件也存在但不索引）",
              "updated": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
              "total": len(square_icons),
              "icons": square_icons
          }
          with open("square.json", "w", encoding="utf-8") as f:
              json.dump(square_data, f, indent=2, ensure_ascii=False)

          # 生成 circle.json（仅 128x128 圆形）
          circle_data = {
              "name": "solnce 128x128 圆形图标库",
              "description": "仓库内所有图标的 128x128 圆形版本索引（位于 resized/<name>/128-circle.png，其他尺寸文件也存在但不索引）",
              "updated": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
              "total": len(circle_icons),
              "icons": circle_icons
          }
          with open("circle.json", "w", encoding="utf-8") as f:
              json.dump(circle_data, f, indent=2, ensure_ascii=False)

          print(f"Generated square.json and circle.json (only indexing 128x128, but all sizes generated)")
          PY

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update multi-size icons (index only 128x128 square/circle)"
          file_pattern: square.json circle.json resized/
