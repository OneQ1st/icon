name: Generate icon.json

on:
  push:
    paths:
      - '*.png'
      - '*.jpg'
      - '*.jpeg'
      - '*.svg'
      - '*.webp'
      - '*.gif'
    branches: [main]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate resized PNGs and icon.json
        shell: bash  # 关键：强制使用 bash
        run: |
          REPO="${{ github.repository }}"
          mkdir -p resized
          echo "[]" > tmp.json

          # 定义要生成的尺寸
          SIZES=(16 32 64 128 256 512)

          shopt -s nullglob

          # 处理位图格式（png/jpg/jpeg/webp/gif）
          for file in *.{png,jpg,jpeg,webp,gif}; do
            [[ -f "$file" ]] || continue
            [[ "$file" == "icon.json" ]] && continue

            name="${file%.*}"
            icon_dir="resized/$name"
            mkdir -p "$icon_dir"

            original_url="https://raw.githubusercontent.com/$REPO/main/$file"

            # 添加原始文件条目
            jq --arg n "$name" --arg u "\( original_url" --arg s "original" --arg t " \){file##*.}" \
              '. += [{"name": $n, "url": $u, "size": $s, "type": $t}]' tmp.json > tmp2.json
            mv tmp2.json tmp.json

            # 生成各个尺寸
            for size in "${SIZES[@]}"; do
              output_file="\( icon_dir/ \){size}.png"
              magick "\( file" -resize " \){size}x\( {size}>" -background none -gravity center -extent " \){size}x${size}" "$output_file"

              size_url="https://raw.githubusercontent.com/$REPO/main/$output_file
