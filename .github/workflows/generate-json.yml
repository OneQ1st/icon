name: Generate icon.json

on:
  push:
    paths:
      - '*.png'
      - '*.jpg'
      - '*.jpeg'
      - '*.svg'
      - '*.webp'
      - '*.gif'
    branches: [main]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate icon.json
        run: |
          REPO="${{ github.repository }}"
          echo "[]" > tmp.json
          
          shopt -s nullglob
          for file in *.{png,jpg,jpeg,svg,webp,gif}; do
            # 跳过 icon.json 本身
            [[ "$file" == "icon.json" ]] && continue
            
            name="${file%.*}"  # 去掉后缀
            url="https://raw.githubusercontent.com/$REPO/main/$file"
            
            jq --arg n "$name" --arg u "$url" '. += [{"name": $n, "url": $u}]' tmp.json > tmp2.json
            mv tmp2.json tmp.json
          done
          
          # 生成最终美观的 icon.json
          jq -n \
            --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --slurpfile items tmp.json \
            '{
              name: "solnce 图标库",
              description: "仓库内所有图标的自动索引",
              updated: $updated,
              total: ($items[0] | length),
              icons: $items[0]
            }' > icon.json
          
          rm tmp.json

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update icon.json"
          file_pattern: icon.json
