name: Generate icon.json

on:
  push:
    paths:
      - '*.png'
      - '*.jpg'
      - '*.jpeg'
      - '*.svg'
      - '*.webp'
      - '*.gif'
    branches: [main]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Pillow
        run: pip install pillow

      - name: Generate 256x256 icons and icon.json (only 256 version)
        run: |
          python - <<'PY'
          import os
          import json
          from datetime import datetime
          from PIL import Image

          REPO = os.getenv("GITHUB_REPOSITORY")
          TARGET_SIZE = 256

          icons = []
          os.makedirs("resized", exist_ok=True)

          for file in os.listdir("."):
            lowercase = file.lower()
            if lowercase.endswith((".png", ".jpg", ".jpeg", ".webp", ".gif")) and os.path.isfile(file):
              name = os.path.splitext(file)[0]
              icon_dir = os.path.join("resized", name)
              os.makedirs(icon_dir, exist_ok=True)

              try:
                  with Image.open(file) as img:
                    img = img.convert("RGBA")  # 支持透明

                    # 缩小到不超过 256x256，保持比例
                    img.thumbnail((TARGET_SIZE, TARGET_SIZE), Image.LANCZOS)

                    # 如果不是正方形，居中扩展透明背景
                    if img.size != (TARGET_SIZE, TARGET_SIZE):
                        new_img = Image.new("RGBA", (TARGET_SIZE, TARGET_SIZE), (0, 0, 0, 0))
                        offset = ((TARGET_SIZE - img.width) // 2, (TARGET_SIZE - img.height) // 2)
                        new_img.paste(img, offset, img)
                        img = new_img

                    output_path = os.path.join(icon_dir, "256.png")
                    img.save(output_path, "PNG", optimize=True)

                    size_url = f"https://raw.githubusercontent.com/{REPO}/main/{output_path}"
                    icons.append({
                        "name": name,
                        "url": size_url,
                        "size": "256x256",
                        "type": "png"
                    })
              except Exception as e:
                  print(f"Failed to process {file}: {e}")

            # SVG 只索引（不生成 PNG）
            elif lowercase.endswith(".svg") and os.path.isfile(file):
              name = os.path.splitext(file)[0]
              url = f"https://raw.githubusercontent.com/{REPO}/main/{file}"
              icons.append({
                  "name": name,
                  "url": url,
                  "size": "256x256",  # 统一标为 256x256 方便前端使用（实际为矢量）
                  "type": "svg"
              })

          # 生成 icon.json（仅包含 256 版本）
          data = {
              "name": "solnce 图标库",
              "description": "仓库内所有图标的 256x256 版本索引（位图位于 resized/<name>/256.png，SVG 为原始矢量文件）",
              "updated": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
              "total": len(icons),
              "icons": icons
          }

          with open("icon.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2, ensure_ascii=False)

          print(f"Generated icon.json with {len(icons)} icons (only 256x256 or SVG)")
          PY

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update icon.json and 256x256 icons"
          file_pattern: icon.json resized/
