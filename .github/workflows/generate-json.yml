name: Generate icon.json

on:
  push:
    paths:
      - '*'           # 监控根目录文件
      - '!.*'         # 排除隐藏文件
      - '!.github/**' # 排除工作流自身
    branches:
      - main
  workflow_dispatch:  # 支持手动运行

jobs:
  generate-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate icon.json
        run: |
          REPO_FULL_NAME="${{ github.repository }}"
          BRANCH="main"
          
          # 直接使用 jq 扫描当前目录并构建最终的 icon.json
          # 过滤逻辑：是文件、后缀匹配、不是 icon.json 本身
          ls | jq -Rs '
            split("\n") 
            | map(select(test("\\.(png|jpg|svg)$") and . != "icon.json")) 
            | map({
                name: . | sub("\\.[^.]+$"; ""), 
                url: "https://raw.githubusercontent.com/'$REPO_FULL_NAME'/'$BRANCH'/" + .
              })
            | {
                name: "图标库",
                description: "主目录图标自动索引",
                icons: .
              }
          ' > icon.json

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update icon.json [skip ci]"
          file_pattern: icon.json
