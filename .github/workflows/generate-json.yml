name: Generate icon.json

on:
  push:
    paths:
      - '*.png'
      - '*.jpg'
      - '*.jpeg'
      - '*.svg'
      - '*.webp'
      - '*.gif'
    branches: [main]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ImageMagick + jq)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y imagemagick jq

      - name: Verify commands exist
        run: |
          which convert || echo "convert not found"
          which magick || echo "magick not found (normal)"
          which jq || echo "jq not found"
          convert -version || echo "convert failed"
          jq --version

      - name: Relax ImageMagick policy (fix delegate/resource errors)
        run: |
          POLICY_FILE="/etc/ImageMagick-6/policy.xml"
          if [ -f "$POLICY_FILE" ]; then
            sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' $POLICY_FILE
            sudo sed -i 's/rights="none" pattern="WEBP"/rights="read|write" pattern="WEBP"/' $POLICY_FILE
            sudo sed -i 's/rights="none" pattern="XPS"/rights="read|write" pattern="XPS"/' $POLICY_FILE
            sudo sed -i '/<!-- <policy domain="resource" name="memory" value="256MiB"\/> -->/a <policy domain="resource" name="memory" value="2GiB"\/>' $POLICY_FILE
            sudo sed -i '/<!-- <policy domain="resource" name="disk" value="1GiB"\/> -->/a <policy domain="resource" name="disk" value="8GiB"\/>' $POLICY_FILE
          fi

      - name: Generate resized PNGs and icon.json
        shell: bash
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          mkdir -p resized
          echo "[]" > tmp.json

          SIZES=(16 32 64 128 256 512)

          shopt -s nullglob

          # 明确使用 convert 命令（最兼容）
          CONVERT_CMD="convert"

          for file in *.{png,jpg,jpeg,webp,gif}; do
            [[ -f "$file" ]] || continue
            [[ "$file" == "icon.json" ]] && continue

            name="${file%.*}"
            icon_dir="resized/$name
